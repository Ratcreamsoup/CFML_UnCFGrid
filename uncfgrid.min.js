!function(g,t,e,n){"use strict";if(!jQuery().DataTable)throw new Error("jQuery DataTable plugin required.");var a="UnCFGrid",r={dtOptions:{processing:!0,serverSide:!0,pageLength:25,searching:!1,paging:!0,dom:"rt<'UnCFGrid_savereset'>p",order:[[0,"asc"]]},language:{save:"Save",reset:"Reset",reload:"Reload"},showNullRows:!1,getUrl:"",getParams:{},updUrl:"",validators:{notempty:function(t){return 0<t.length}}},u="ucfgChanged",f="ucfgCheck",p="ucfgDelete",b=!1,v=!1,m="ucfgVal",l=function(t,e){t.prop("disabled",!e)},c=function(t,e,n){for(var a=t.length-1;0<=a;a--)if(void 0===n||t[a].dataSource==n.dataSource){for(var r=!0,i=1;i<e.length;i++)t[a][e[a].putKey]!==n[e[a].putKey]&&(r=!1);r&&t.splice(a,1)}return t},o=function(t,e,n,a){g.ajax({type:"POST",url:e,cache:!1,data:{argumentCollection:JSON.stringify(t)},dataType:"json",complete:function(){a&&n.ajax.reload(null,!1)}})},i=function(t,e){this.domElem=t,this.elem=g(t),this.settings=g.extend(!0,{},r,e),this._defaults=r,this._name=a,this.init()};g.extend(i.prototype,{init:function(){var d=this;this.arrChanged=[],this.columnConfig=function(t,o,s,d){var u=[],l=[],c=[],h=[];if(t.find("thead th").each(function(t){var e=g(this),n={},a=e.data("ucfgEdit"),r=e.data("ucfgPrimary");if(n.data=e.data("ucfgData")||"",""==n.data&&(l.push(t),n.defaultContent=""),void 0!==r&&n.data){var i={getKey:n.data};i.putKey=""==r?n.data:r,c.push(i)}void 0!==e.data(f)?(n.render=d,b=!0):void 0!==e.data("ucfgDel")?(n.render=s,n.className=p,n.orderable=!1,v=!0):void 0!==a&&(n.render=o,b=!0,""!==a&&(n.className=m,h[t]=a)),u.push(n)}),(b||v)&&!c.length)throw new Error("No primary key found.\nAt least one column needs to be assigned with attribute data-ucfg-primary when using edit/delete");return{columns:u,pkey:c,validator:h}}(this.elem,this.renderEditableSpan,this.renderDelete,this.renderCheckbox),this.dtOptions=g.extend(!0,{},this.getGridConfig(),this.settings.dtOptions),this.objDt=this.elem.DataTable(this.dtOptions),this.buttons=b?this.elem.nextAll("div.UnCFGrid_savereset").html('<button type="save">'+this.settings.language.save+'</button><button type="reset">'+this.settings.language.reset+'</button><button type="button">'+this.settings.language.reload+"</button>").find("button"):this.elem.nextAll("div.UnCFGrid_savereset").html('<button type="button">'+this.settings.language.reload+"</button>").find("button"),this.saveResetButtons=this.buttons.filter('button[type="save"],button[type="reset"]'),v&&this.elem.on("click","td."+p,function(){for(var t=g(this),e={gridaction:"D",gridrow:{},gridchanged:{}},n=d.objDt.cell(t).index(),a=d.columnConfig.pkey,r=0;r<a.length;r++)e.gridrow[a[r].putKey]=d.objDt.row(n.row).data()[a[r].getKey];d.arrChanged=c(d.arrChanged,a),o(e,d.settings.updUrl,d.objDt,!0)}),this.buttons.filter('[type="button"]').click(function(){d.objDt.ajax.reload(null,!1),d.arrChanged=[],l(d.saveResetButtons,!1)}),b&&(this.elem.on("focus","span[contenteditable='true']",function(){var t=g(this);t.data("beforeContentEdit",t.html())}).on("blur","span[contenteditable='true']",function(){var t=g(this),e=t.parent(),n=t.html(),a=t.data("beforeContentEdit"),r=!0;if(e.hasClass(m)){var i=d.columnConfig.validator[d.objDt.cell(e).index().column];d.settings.validators.hasOwnProperty(i)&&(r=d.settings.validators[i](n))}r?t.data("beforeContentEdit")!==t.html()&&t.removeData("beforeContentEdit").trigger("change"):t.html(a)}).on("change",'span[contenteditable="true"],input.'+f,function(){for(var t=g(this),e=!1,n=d.objDt.cell(t.parent()[0]).index(),a=d.columnConfig.pkey,r={dataSource:d.objDt.column(n.column).dataSrc()},i=0;i<d.columnConfig.pkey.length;i++)r[a[i].putKey]=d.objDt.row(n.row).data()[a[i].getKey];if(t.is("span"))r.newVal=t.html(),e=!0;else if(t.is("input."+f)){var o=t.data("beforeContentEdit"),s=t.prop("checked");r.newVal=s,void 0===o?(t.data("beforeContentEdit",!s),e=!0):o!==s&&(e=!0)}return d.arrChanged=c(d.arrChanged,a,r),e?(t.addClass(u),d.arrChanged.push(r)):t.removeClass(u),l(d.saveResetButtons,0<d.arrChanged.length),!1}).on("xhr.dt",function(){d.arrChanged=[],l(d.saveResetButtons,!1)}),this.buttons.filter('[type="save"]').click(function(){g.each(d.arrChanged,function(t,e){var n={gridaction:"U",gridrow:{},gridchanged:{}},a=d.columnConfig.pkey;n.gridchanged[e.dataSource]=e.newVal;for(var r=0;r<a.length;r++){var i=a[r].putKey;n.gridrow[i]=e[i]}o(n,d.settings.updUrl,d.objDt,t+1==d.arrChanged.length)}),d.arrChanged=[],l(d.saveResetButtons,!1)}),this.buttons.filter('[type="reset"]').click(function(){d.elem.find("span[contenteditable='true']."+u).each(function(){var t=g(this);t.html(d.objDt.cell(t.parent()[0]).data()).removeClass(u)}),d.elem.find('input[type="checkbox"].'+f+"."+u).each(function(){var t=g(this);t.prop("checked",d.objDt.cell(t.parent()[0]).data()).removeClass(u)}),d.arrChanged=[],l(d.saveResetButtons,!1)}))},renderEditableSpan:function(t,e,n,a){return'<span contenteditable="true">'+t+"</span>"},renderDelete:function(){return"<div />"},renderCheckbox:function(t,e,n,a){var r='<input class="'+f+'" type="checkbox" ';return t&&(r+='checked="checked" '),r+="/>"},getDataFilter:function(u,t){return function(t){for(var e=jQuery.parseJSON(t),n={},a=[],r=e.QUERY.DATA.length,i=e.QUERY.COLUMNS.length,o=0;o<r;o++)if(u.showNullRows||e.QUERY.DATA[o].some(function(t){return null!==t})){for(var s={},d=0;d<i;d++)s[e.QUERY.COLUMNS[d]]=e.QUERY.DATA[o][d];a.push(s)}return n.data=a,n.recordsTotal=e.TOTALROWCOUNT,n.recordsFiltered=n.recordsTotal,n.draw=e.draw,JSON.stringify(n)}},getData:function(i){return function(t){var e={pageSize:t.length,page:1+t.start/t.length,gridsortdirection:t.order[0].dir,returnFormat:"json",draw:t.draw},n=t.order[0].column;switch(e.gridsortcolumn=t.columns[n].data,typeof i.getParams){case"object":var a=i.getParams;break;case"function":a=i.getParams()}for(var r in a)!e.hasOwnProperty(r)&&a.hasOwnProperty(r)&&(e[r]=a[r]);return e}},getGridConfig:function(){return{columns:this.columnConfig.columns,ajax:{url:this.settings.getUrl,data:this.getData(this.settings),dataFilter:this.getDataFilter(this.settings,this.arrChanged)}}}}),g.fn[a]=function(t){return this.each(function(){g.data(this,"plugin_"+a)||g.data(this,"plugin_"+a,new i(this,t))})}}(jQuery,window,document);