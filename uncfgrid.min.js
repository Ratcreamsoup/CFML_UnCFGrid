!function(t,e,n,a){"use strict";if(!jQuery().DataTable)throw new Error("jQuery DataTable plugin required.");var r="UnCFGrid",i={dtOptions:{processing:!0,serverSide:!0,pageLength:25,searching:!1,paging:!0,dom:"rt<'UnCFGrid_savereset'>p",order:[[0,"asc"]]},language:{save:"Save",reset:"Reset",reload:"Reload"},showNullRows:!1,getUrl:"",getParams:{},updUrl:"",validators:{notempty:function(t){return t.length>0}}},o="ucfgChanged",s="ucfgCheck",d="ucfgDelete",u=!1,l=!1,h="ucfgVal",c=function(t,e){t.prop("disabled",!e)},g=function(t,e,n){for(var a=t.length-1;a>=0;a--)if(void 0===n||t[a].dataSource==n.dataSource){for(var r=!0,i=1;i<e.length;i++)t[a][e[a].putKey]!==n[e[a].putKey]&&(r=!1);r&&t.splice(a,1)}return t},f=function(e,n,a,r){t.ajax({type:"POST",url:n,cache:!1,data:{argumentCollection:JSON.stringify(e)},dataType:"json",complete:function(){r&&a.ajax.reload(null,!1)}})},p=function(e,n){this.domElem=e,this.elem=t(e),this.settings=t.extend(!0,{},i,n),this._defaults=i,this._name=r,this.init()};t.extend(p.prototype,{init:function(){var e=this;this.arrChanged=[],this.columnConfig=function(e,n,a,r){var i=[],o=[],c=[],g=[];if(e.find("thead th").each(function(e){var f=t(this),p={},b=f.data("ucfgEdit"),m=f.data("ucfgPrimary");if(p.data=f.data("ucfgData")||"",""==p.data&&(o.push(e),p.defaultContent=""),void 0!==m&&p.data){var v={getKey:p.data};v.putKey=""==m?p.data:m,c.push(v)}void 0!==f.data(s)?(p.render=r,u=!0):void 0!==f.data("ucfgDel")?(p.render=a,p.className=d,p.orderable=!1,l=!0):void 0!==b&&(p.render=n,u=!0,""!==b&&(p.className=h,g[e]=b)),i.push(p)}),(u||l)&&!c.length)throw new Error("No primary key found.\nAt least one column needs to be assigned with attribute data-ucfg-primary when using edit/delete");return{columns:i,pkey:c,validator:g}}(this.elem,this.renderEditableSpan,this.renderDelete,this.renderCheckbox),this.dtOptions=t.extend(!0,{},this.getGridConfig(),this.settings.dtOptions),this.objDt=this.elem.DataTable(this.dtOptions),this.buttons=u?this.elem.nextAll("div.UnCFGrid_savereset").html('<button type="save">'+this.settings.language.save+'</button><button type="reset">'+this.settings.language.reset+'</button><button type="button">'+this.settings.language.reload+"</button>").find("button"):this.elem.nextAll("div.UnCFGrid_savereset").html('<button type="button">'+this.settings.language.reload+"</button>").find("button"),this.saveResetButtons=this.buttons.filter('button[type="save"],button[type="reset"]'),l&&this.elem.on("click","td."+d,function(){for(var n=t(this),a={gridaction:"D",gridrow:{},gridchanged:{}},r=e.objDt.cell(n).index(),i=e.columnConfig.pkey,o=0;o<i.length;o++)a.gridrow[i[o].putKey]=e.objDt.row(r.row).data()[i[o].getKey];e.arrChanged=g(e.arrChanged,i),f(a,e.settings.updUrl,e.objDt,!0)}),this.buttons.filter('[type="button"]').click(function(){e.objDt.ajax.reload(null,!1),e.arrChanged=[],c(e.saveResetButtons,!1)}),u&&(this.elem.on("focus","span[contenteditable='true']",function(){var e=t(this);e.data("beforeContentEdit",e.html())}).on("blur","span[contenteditable='true']",function(){var n=t(this),a=n.parent(),r=n.html(),i=n.data("beforeContentEdit"),o=!0;if(a.hasClass(h)){var s=e.columnConfig.validator[e.objDt.cell(a).index().column];e.settings.validators.hasOwnProperty(s)&&(o=e.settings.validators[s](r))}o?n.data("beforeContentEdit")!==n.html()&&n.removeData("beforeContentEdit").trigger("change"):n.html(i)}).on("change",'span[contenteditable="true"],input.'+s,function(){for(var n=t(this),a=!1,r=e.objDt.cell(n.parent()[0]).index(),i=e.columnConfig.pkey,d={dataSource:e.objDt.column(r.column).dataSrc()},u=0;u<e.columnConfig.pkey.length;u++)d[i[u].putKey]=e.objDt.row(r.row).data()[i[u].getKey];if(n.is("span"))d.newVal=n.html(),a=!0;else if(n.is("input."+s)){var l=n.data("beforeContentEdit"),h=n.prop("checked");d.newVal=h,void 0===l?(n.data("beforeContentEdit",!h),a=!0):l!==h&&(a=!0)}return e.arrChanged=g(e.arrChanged,i,d),a?(n.addClass(o),e.arrChanged.push(d)):n.removeClass(o),c(e.saveResetButtons,e.arrChanged.length>0),!1}).on("xhr.dt",function(){e.arrChanged=[],c(e.saveResetButtons,!1)}),this.buttons.filter('[type="save"]').click(function(){t.each(e.arrChanged,function(t,n){var a={gridaction:"U",gridrow:{},gridchanged:{}},r=e.columnConfig.pkey;a.gridchanged[n.dataSource]=n.newVal;for(var i=0;i<r.length;i++){var o=r[i].putKey;a.gridrow[o]=n[o]}f(a,e.settings.updUrl,e.objDt,t+1==e.arrChanged.length)}),e.arrChanged=[],c(e.saveResetButtons,!1)}),this.buttons.filter('[type="reset"]').click(function(){e.elem.find("span[contenteditable='true']."+o).each(function(){var n=t(this);n.html(e.objDt.cell(n.parent()[0]).data()).removeClass(o)}),e.elem.find('input[type="checkbox"].'+s+"."+o).each(function(){var n=t(this);n.prop("checked",e.objDt.cell(n.parent()[0]).data()).removeClass(o)}),e.arrChanged=[],c(e.saveResetButtons,!1)}))},renderEditableSpan:function(t,e,n,a){return'<span contenteditable="true">'+t+"</span>"},renderDelete:function(){return"<div />"},renderCheckbox:function(t,e,n,a){var r='<input class="'+s+'" type="checkbox" ';return t&&(r+='checked="checked" '),r+="/>"},getDataFilter:function(t,e){return function(e){for(var n=jQuery.parseJSON(e),a={},r=[],i=n.QUERY.DATA.length,o=n.QUERY.COLUMNS.length,s=0;s<i;s++)if(t.showNullRows||n.QUERY.DATA[s].some(function(t){return null!==t})){for(var d={},u=0;u<o;u++)d[n.QUERY.COLUMNS[u]]=n.QUERY.DATA[s][u];r.push(d)}return a.data=r,a.recordsTotal=n.TOTALROWCOUNT,a.recordsFiltered=a.recordsTotal,a.draw=n.draw,JSON.stringify(a)}},getData:function(t){return function(e){var n={pageSize:e.length,page:1+e.start/e.length,gridsortdirection:e.order[0].dir,returnFormat:"json",draw:e.draw},a=e.order[0].column;n.gridsortcolumn=e.columns[a].data;for(var r in t.getParams)!n.hasOwnProperty(r)&&t.getParams.hasOwnProperty(r)&&(n[r]=t.getParams[r]);return n}},getGridConfig:function(){return{columns:this.columnConfig.columns,ajax:{url:this.settings.getUrl,data:this.getData(this.settings),dataFilter:this.getDataFilter(this.settings,this.arrChanged)}}}}),t.fn[r]=function(e){return this.each(function(){t.data(this,"plugin_"+r)||t.data(this,"plugin_"+r,new p(this,e))})}}(jQuery,window,document);